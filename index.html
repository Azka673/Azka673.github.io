<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ocean RNG - Time Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #030308; --primary: #00d2d3; --fire: #ff4757; --gold: #f1c40f; --purple: #a55eea; --green: #2ecc71;
            --glass: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.1);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html { margin:0; padding:0; height:100%; font-family:'Inter', sans-serif; background:var(--bg); color:#fff; overflow:hidden; }

        #weather-fx {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; overflow: hidden;
            transition: background 1s ease;
        }

        .layout { display: flex; height: 100vh; position: relative; z-index: 2; background: rgba(3, 3, 8, 0.6); }
        
        .sidebar { 
            width: 280px; background: rgba(0,0,0,0.95); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; padding: 20px; z-index: 10; gap: 8px; flex-shrink: 0;
            overflow-y: auto;
        }

        .content { flex: 1; overflow-y: auto; padding: 40px; position: relative; display: flex; flex-direction: column; align-items: center; }

        /* Animation Keyframes */
        @keyframes rain { 0% { transform: translateY(-100vh); } 100% { transform: translateY(100vh); } }
        @keyframes snow { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(100vh) rotate(360deg); } }
        @keyframes flash { 0%, 90%, 100% { opacity: 0; } 92%, 95% { opacity: 0.3; } }
        @keyframes pop { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes shake { 0% {transform: translate(0)} 25% {transform: translate(2px, -2px)} 75% {transform: translate(-2px, 2px)} }

        .particle { position: absolute; background: #fff; width: 2px; height: 15px; opacity: 0.3; }
        .snow-particle { border-radius: 50%; width: 5px; height: 5px; }
        .lightning { position: absolute; inset: 0; background: #fff; opacity: 0; animation: flash 5s infinite; }

        .btn { background: var(--glass); border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.2s; text-align: left; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .btn:hover, .btn.active { background: var(--primary); color: #000; border-color: transparent; transform: scale(1.02); }
        .btn:active { transform: scale(0.98); }
        
        .btn-quest { border: 1px solid var(--purple); color: var(--purple); }
        .btn-quest:hover { background: var(--purple); color: #fff; }
        .btn-altar { border: 1px solid var(--fire); color: var(--fire); }
        .btn-altar:hover { background: var(--fire); color: #fff; }

        /* AREA MEMANCING */
        .bar-track { 
            width: 100%; max-width: 600px; height: 45px; 
            background: #000; border-radius: 20px; position: relative; 
            overflow: hidden; border: 2px solid #222; margin: 20px 0; 
            touch-action: none; 
        }
        .green-zone { height: 100%; background: var(--primary); position: absolute; box-shadow: 0 0 20px var(--primary); transition: 0.1s; }
        .pointer { 
            width: 6px; height: 100%; background: #fff; position: absolute; z-index: 5; 
            box-shadow: 0 0 15px #fff; 
            /* Will-change optimization for smooth movement */
            will-change: left; 
        }

        .action-btn { padding: 18px 60px; font-size: 22px; font-weight: 900; background: var(--primary); border: none; border-radius: 15px; cursor: pointer; color: #000; transition: 0.2s; width: 100%; max-width: 300px; box-shadow: 0 5px 15px rgba(0, 210, 211, 0.3); }
        .action-btn:active { transform: scale(0.95); }
        .action-btn.reeling { background: var(--fire); color: #fff; box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3); }

        .xp-container { background: #222; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .xp-fill { height: 100%; background: var(--green); width: 0%; transition: 0.3s; }

        #gacha-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 5000; display: none; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 20px; }
        .gacha-icon { font-size: 100px; animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .gacha-name { font-size: 32px; font-weight: 900; word-wrap: break-word; max-width: 100%; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; width: 100%; padding-bottom: 50px; }
        .card { background: var(--glass); border: 1px solid var(--border); padding: 12px; border-radius: 12px; text-align: center; font-size: 12px; position: relative; }
        
        .quest-box { width: 100%; max-width: 500px; padding: 20px; border: 1px solid var(--purple); background: rgba(165, 94, 234, 0.1); border-radius: 15px; margin-bottom: 20px; }
        .progress-bar { width: 100%; height: 10px; background: #333; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--purple); width: 0%; transition: 0.3s; }

        #toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 10px 30px; border-radius: 50px; font-weight: bold; opacity: 0; z-index: 9999; pointer-events: none; transition: 0.3s; width: max-content; max-width: 90%; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        
        #mobile-stats-bar { display: none; }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 850px) {
            .layout { flex-direction: column; }
            .sidebar { 
                width: 100%; height: auto; flex-direction: row; flex-wrap: wrap; 
                order: 2; padding: 8px; gap: 5px; border-right: none; border-top: 1px solid var(--border); background: #000; justify-content: center;
            }
            .sidebar .card.desktop-only { display: none; }
            .sidebar h2 { display: none; }
            .sidebar .btn { flex: 1 1 30%; justify-content: center; text-align: center; font-size: 11px; padding: 10px 5px; height: 45px; }
            .content { padding: 20px; padding-top: 70px; order: 1; height: 100%; }
            #mobile-stats-bar {
                display: flex; position: absolute; top: 10px; left: 10px; right: 10px;
                justify-content: space-between; z-index: 100; pointer-events: none;
            }
            .stat-pill {
                background: rgba(0,0,0,0.85); border: 1px solid var(--border);
                padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold;
                display: flex; align-items: center; gap: 5px; backdrop-filter: blur(5px);
            }
            h1 { font-size: 20px; }
            .action-btn { font-size: 18px; padding: 15px; }
            .bar-track { height: 35px; }
            #toast { top: 60px; }
        }
        @media (max-width: 380px) { .sidebar .btn { flex: 1 1 45%; } }

        /* Text Colors */
        .r-legendary { color: var(--gold); text-shadow: 0 0 15px var(--gold); }
        .r-mythic { color: #ff4757; text-shadow: 0 0 20px #ff4757; font-style: italic; }
        .r-secret { color: #fd79a8; text-shadow: 0 0 25px #fd79a8; animation: shake 0.5s infinite; }
        .r-ancient { color: #fff; text-shadow: 0 0 40px #fff; font-size: 50px; font-weight: 900; }
    </style>
</head>
<body>

<div id="weather-fx"></div>
<div id="toast">Notifikasi</div>

<div id="mobile-stats-bar">
    <div class="stat-pill" style="color:var(--gold);">üí∞ <span id="m-money">$0</span></div>
    <div class="stat-pill" style="color:var(--primary);">‚≠ê <span id="m-lvl">Lvl 1</span></div>
</div>

<div id="gacha-overlay" onclick="ui.closeGacha()">
    <div id="g-icon" class="gacha-icon">üêü</div>
    <div id="g-rarity" style="letter-spacing:5px; font-weight:bold; margin: 10px 0; opacity: 0.7;">RARITY</div>
    <div id="g-name" class="gacha-name">ITEM NAME</div>
    <div style="margin-top:30px; font-size:12px; opacity:0.4;">TAP TO CONTINUE</div>
</div>

<div class="layout">
    <aside class="sidebar">
        <h2 style="color:var(--primary); margin:0; text-align:center; margin-bottom:10px;">OCEAN V1</h2>
        <div class="card desktop-only" style="margin-bottom: 5px; text-align: left;">
            <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                <b id="lvl-display">Lvl 1</b>
                <span id="luck-bonus-display" style="color:var(--green); font-size:10px;">+0% Luck</span>
            </div>
            <div class="xp-container"><div id="xp-bar" class="xp-fill"></div></div>
            <small id="xp-text" style="opacity:0.6; font-size:10px;">0 / 100 XP</small>
        </div>
        <div class="card desktop-only" style="margin-bottom: 5px;">
            <small>BALANCE</small>
            <div id="stat-money" style="font-size:18px; color:var(--gold); font-weight:900;">$0</div>
        </div>
        <button class="btn active" onclick="ui.tab('game', this)">üé£ Fishing</button>
        <button class="btn btn-quest" onclick="ui.tab('quest', this)">üìú Quest</button>
        <button class="btn btn-altar" onclick="ui.tab('altar', this)">üî• Altar</button>
        <button class="btn" onclick="ui.tab('shop', this)">üõí Shop</button>
        <button class="btn" onclick="ui.tab('upgrade', this)">üõ†Ô∏è Upgrade</button>
        <button class="btn" onclick="ui.tab('inv', this)">üéí Bag</button>
        <button class="btn" onclick="ui.tab('index', this)">üìñ Index</button>
    </aside>

    <main class="content" id="tab-game">
        <h1 id="rod-display" style="margin-bottom:0; color:var(--primary); text-align:center;">WOOD ROD</h1>
        <div id="rod-info" style="color:#666; margin-bottom:20px; font-size: 12px;">Total Luck: 1x</div>
        <div class="bar-track">
            <div class="green-zone" id="green-zone" style="width:20%; left:40%;"></div>
            <div class="pointer" id="pointer"></div>
        </div>
        <button id="main-action" class="action-btn" onclick="game.handleAction()">CAST</button>
        <div id="weather-display" style="margin-top:20px; font-size:14px; font-weight:bold; color: #888;">‚òÄÔ∏è Sunny</div>
        <div id="sell-bonus-display" style="font-size:11px; color:var(--gold); margin-top:4px;">Selling: 1.0x</div>
        <div id="boost-timer" style="margin-top: 10px; color: var(--fire); font-size: 14px; font-weight: bold; height: 20px;"></div>
    </main>

    <main class="content" id="tab-quest" style="display:none;">
        <h1>ANCIENT QUEST</h1>
        <div id="quest-display" class="quest-box"></div>
    </main>

    <main class="content" id="tab-altar" style="display:none;">
        <h1>ALTAR SACRIFICE</h1>
        <div class="card" style="width:100%; max-width:400px; margin-bottom: 20px; border:1px solid var(--fire);">
            <h3 style="color:var(--fire); margin-top:0;">ü©∏ BLOOD SACRIFICE</h3>
            <p style="font-size: 13px; opacity: 0.8;">Sacrifice 1 Legendary+ Fish.</p>
            <p style="color:var(--gold); font-weight:bold;">REWARD: 1.3x Luck (5 Min)</p>
            <button class="btn" style="width:100%; justify-content:center; background:var(--fire);" onclick="game.sacrificeFish()">SACRIFICE FISH</button>
        </div>
        <div class="card" style="width:100%; max-width:400px; border:1px solid var(--gold);">
            <h3 style="color:var(--gold); margin-top:0;">üí∞ GOLDEN OFFERING</h3>
            <p style="font-size: 13px; opacity: 0.8;">Offer money to the sea gods.</p>
            <p style="color:var(--gold); font-weight:bold;">COST: $500 -> Get 1 Fish</p>
            <button class="btn" style="width:100%; justify-content:center; background:var(--gold); color:#000;" onclick="game.sacrificeMoney()">SACRIFICE $500</button>
        </div>
    </main>

    <main class="content" id="tab-upgrade" style="display:none;">
        <h1>UPGRADE REEL</h1>
        <p style="font-size: 13px; opacity: 0.6;">Make green bar bigger. Max Lvl 5.</p>
        <div id="upgrade-list" style="width: 100%; max-width: 400px;"></div>
    </main>

    <main class="content" id="tab-inv" style="display:none;">
        <div id="inv-header-container" style="width:100%; display:flex; justify-content:space-between; align-items: center; margin-bottom:20px;">
            <div>
                <h2 style="margin:0;">Inventory</h2>
                <div id="bag-total-value" style="color:var(--gold); font-weight:bold; font-size:12px;">Value: $0</div>
            </div>
            <button class="btn" style="background:var(--fire);" onclick="game.sellAll()">SELL ALL</button>
        </div>
        <div id="inv-grid" class="grid"></div>
    </main>

    <main class="content" id="tab-shop" style="display:none;"><h2>Shop Rods</h2><div id="shop-grid" class="grid"></div></main>
    <main class="content" id="tab-index" style="display:none;"><h2>Fish Index</h2><div id="index-grid" class="grid"></div></main>
</div>

<script>
const DB = {
    // KECEPATAN: Diubah ke % Per Detik (bukan per frame)
    speed: { base: 75, reel: 125 }, 
    quests: [
        { desc: "Catch 500 Fish", target: "any", count: 500 },
        { desc: "Catch 75 Mythic Fish", target: "mythic", count: 75 },
        { desc: "Catch 25 Secret Fish", target: "secret", count: 25 },
        { desc: "Catch 1 Ancient Fish", target: "ancient", count: 1 },
        { desc: "Reach Level 75", target: "level", count: 75 }
    ],
    rarity: {
        common: { n: "Common", c: 2, col: "#aab", xp: 25 },
        rare: { n: "Rare", c: 15, col: "#2e86de", xp: 50 },
        epic: { n: "Epic", c: 100, col: "#8e44ad", xp: 75 },
        legendary: { n: "Legendary", c: 800, col: "#f1c40f", xp: 500 },
        mythic: { n: "Mythic", c: 4500, col: "#e74c3c", xp: 1500 },
        secret: { n: "Secret", c: 25000, col: "#fd79a8", xp: 10000 },
        ancient: { n: "Ancient", c: 150000, col: "#fff", xp: 30000 }
    },
    fish: [],
    rods: [
        { id: 'wood', n: "Wood Rod", b: 0, cost: 0 },
        { id: 'bamboo', n: "Bamboo Rod", b: 100, cost: 5000 },
        { id: 'iron', n: "Iron Rod", b: 500, cost: 25000 },
        { id: 'fiber', n: "Fiberglass", b: 1500, cost: 100000 },
        { id: 'steel', n: "Steel Rod", b: 5000, cost: 250000 },
        { id: 'silver', n: "Silver Rod", b: 12000, cost: 500000 },
        { id: 'gold', n: "Gold Rod", b: 30000, cost: 1000000 },
        { id: 'platinum', n: "Platinum Rod", b: 75000, cost: 2000000 },
        { id: 'obsidian', n: "Obsidian Rod", b: 150000, cost: 3500000 },
        { id: 'carbon', n: "Carbon Elite", b: 350000, cost: 5000000 },
        { id: 'emerald', n: "Emerald Rod", b: 600000, cost: 6500000 },
        { id: 'ruby', n: "Ruby Rod", b: 1000000, cost: 7500000 },
        { id: 'sapphire', n: "Sapphire Rod", b: 2000000, cost: 8500000 },
        { id: 'diamond', n: "Diamond Rod", b: 4500000, cost: 9500000 },
        { id: 'zenith_lite', n: "Zenith Pro", b: 10000000, cost: 9999999 },
        { id: 'god_slayer', n: "üó°Ô∏è GOD SLAYER", b: 25000000, cost: 0, quest: true }
    ],
    weather: [
        { n:"‚òÄÔ∏è Sunny", l:1, s:1, bg: "rgba(0,0,0,0)" },
        { n:"‚òÅÔ∏è Cloudy", l:1.2, s:1.1, bg: "#1a1a2e" },
        { n:"üåßÔ∏è Rainy", l:1.6, s:1.3, bg: "#0f172a", fx: "rain" },
        { n:"‚õàÔ∏è Storm", l:2.2, s:1.5, bg: "#020617", fx: "storm" },
        { n:"üå´Ô∏è Fog", l:1.4, s:1.2, bg: "rgba(255,255,255,0.1)" },
        { n:"‚ùÑÔ∏è Snow", l:2.0, s:1.6, bg: "#1e293b", fx: "snow" },
        { n:"üå™Ô∏è Blizzard", l:3.0, s:2.0, bg: "#0f172a", fx: "snow" },
        { n:"üåë Eclipse", l:5.5, s:3.5, bg: "#000" },
        { n:"üåï Moon", l:2.5, s:1.8, bg: "#0c0c1e" },
        { n:"üåà Rainbow", l:3.5, s:2.5, bg: "linear-gradient(45deg, #4b0082, #000)" },
        { n:"üåå Stellar", l:7.5, s:4.0, bg: "#050510" },
        { n:"‚òÑÔ∏è Meteor", l:6.5, s:4.2, bg: "#1a0f0f" },
        { n:"üî• Heat", l:1.2, s:3.0, bg: "#2a1010" },
        { n:"‚ú® Aurora", l:5.0, s:3.8, bg: "#051a1a" },
        { n:"ü•Ä Blood", l:7.0, s:4.5, bg: "#200" },
        { n:"üí† Glitch", l:7.5, s:2.2, bg: "#001a1a" }
    ]
};

const names = {
    common: [["Sardine","üêü"], ["Plastic Bag","üõçÔ∏è"], ["Twig","üåø"], ["Bottle Cap","üß¥"], ["Anchovy","üêü"], ["Rock","ü™®"], ["Trash","üóëÔ∏è"], ["Tin Can","ü•´"], ["Seaweed","üåø"], ["Goldfish","üê†"], ["Old Boot","ü•æ"], ["Paper Plane","‚úàÔ∏è"], ["Rusty Nail","üìå"], ["Algae","ü¶†"], ["Small Pebble","ü™®"]],
    rare: [["Blue Tuna","üêü"], ["Squid","ü¶ë"], ["Stingray","üê°"], ["Grouper","üêü"], ["Swordfish","üó°Ô∏è"], ["Bronze Coin","ü™ô"], ["Pearl Oyster","ü¶™"], ["Clownfish","üê†"], ["Axolotl","ü¶é"], ["Octopus","üêô"], ["Lobster","ü¶û"], ["Crab","ü¶Ä"], ["Sea Horse","üêé"], ["Electric Eel","üêç"], ["Jellyfish","ü™º"]],
    epic: [["Blue Shark","ü¶à"], ["Dolphin","üê¨"], ["Magma Orb","üîÆ"], ["Hammerhead","ü¶à"], ["Orca","üêã"], ["Golden Swordfish","‚öîÔ∏è"], ["Treasure Box","üì¶"], ["Manta Ray","üåä"], ["Great White","ü¶à"], ["Emerald Crab","ü¶Ä"], ["Neon Jellyfish","‚ú®"], ["Sunfish","‚òÄÔ∏è"], ["King Squid","ü¶ë"]],
    legendary: [["Megalodon","ü¶à"], ["Kraken","üêô"], ["Golden Idol","üóø"], ["Hydra Baby","üêâ"], ["Sea Serpent","üêç"], ["Poseidon Fork","üî±"], ["Lava Shark","üî•"], ["Diamond Turtle","üê¢"], ["Ancient Map","üìú"], ["Abyssal Whale","üêã"], ["Cursed Anchor","‚öì"], ["Phoenix Fish","üê¶"]],
    mythic: [["Jormungandr","üêâ"], ["Celestial Dragon","‚ú®"], ["Abyssal Watcher","üëÅÔ∏è"], ["Void Star","‚≠ê"], ["Ocean Orb","üåê"], ["Nebula Ray","üåå"], ["Leviathan","üêâ"], ["Atlantis Key","üîë"], ["Cosmic Jelly","‚òÑÔ∏è"], ["Soul Eater","üëª"]],
    secret: [["The Developer","üíª"], ["Reality Breaker","üí†"], ["God Slayer","üó°Ô∏è"], ["Finger of God","üëÜ"], ["Matrix Fish","üî¢"], ["Error 404","üö´"], ["Glitched Whale","üëæ"], ["Binary Shark","üíæ"], ["Admin Command","‚å®Ô∏è"],["Rafa","67"],["El Ketua Zahid", "üî•"],["El Shark Gran Maja", "??"]],
    ancient: [["THE ONE PIECE","üëë"], ["Chronos Key","üîë"], ["The Beginning","ü•ö"], ["Universal Core","‚öõÔ∏è"], ["Alpha & Omega","‚òØÔ∏è"], ["Infinite Singularity","üï≥Ô∏è"], ["God's Tear","üíß"]]
};

Object.keys(names).forEach(r => { 
    names[r].forEach(nData => { 
        DB.fish.push({ n: nData[0], ico: nData[1], r, v: Math.floor(DB.rarity[r].c * 1.5) }); 
    }); 
});

let player = { 
    money: 0, items: [], found: [], rod: 'wood', ownedRods: ['wood'], 
    upgrades: { reelWidth: 0 }, 
    quest: { stage: 0, progress: 0, completed: false },
    level: 1, xp: 0, maxXp: 100, boostEnd: 0 
};

let state = { pos: 0, dir: 1, isMoving: false, isReeling: false, weather: 0, pending: null };

const game = {
    lastTime: 0,
    init: () => {
        const saved = localStorage.getItem('ocean_v45');
        if(saved) player = { ...player, ...JSON.parse(saved) };
        setInterval(() => { state.weather = Math.floor(Math.random()*DB.weather.length); ui.updateWeatherFX(); ui.update(); }, 30000);
        
        // Reset timestamp agar tidak loncat saat start
        game.lastTime = 0; 
        requestAnimationFrame(game.loop);
        
        ui.update(); ui.updateWeatherFX();
    },
    loop: (timestamp) => {
        // HITUNG DELTA TIME (Waktu yang berlalu antar frame dalam detik)
        if (!game.lastTime) game.lastTime = timestamp;
        const dt = (timestamp - game.lastTime) / 1000;
        game.lastTime = timestamp;

        if(state.isMoving) {
            // Speed = Unit per Detik. dt = pecahan detik.
            // Ini membuat gerakan konsisten di 30fps, 60fps, atau 120fps.
            const speedPerSec = (state.isReeling ? DB.speed.reel : DB.speed.base);
            
            // Batasi dt agar bar tidak loncat jika browser lag/pindah tab (max 0.1s)
            const safeDt = Math.min(dt, 0.1); 
            
            state.pos += (speedPerSec * state.dir) * safeDt;

            if(state.pos >= 100) { state.pos = 100; state.dir = -1; }
            if(state.pos <= 0) { state.pos = 0; state.dir = 1; }
            
            document.getElementById('pointer').style.left = state.pos + '%';
        }
        
        if(Date.now() < player.boostEnd) {
            const left = Math.ceil((player.boostEnd - Date.now()) / 1000);
            document.getElementById('boost-timer').innerText = `üî• 1.3x LUCK: ${Math.floor(left/60)}:${(left%60).toString().padStart(2,'0')}`;
        } else { document.getElementById('boost-timer').innerText = ""; }
        
        requestAnimationFrame(game.loop);
    },
    handleAction: () => {
        if(!state.isMoving) { state.isMoving = true; game.lastTime = performance.now(); ui.update(); return; }
        const gz = document.getElementById('green-zone');
        // Parse float untuk akurasi karena sekarang pos adalah float presisi tinggi
        const gzLeft = parseFloat(gz.style.left);
        const gzWidth = parseFloat(gz.style.width);
        
        const hit = state.pos >= gzLeft && state.pos <= (gzLeft + gzWidth);

        if(!state.isReeling) {
            if(hit) {
                state.isReeling = true; state.pending = game.roll();
                const btn = document.getElementById('main-action');
                btn.innerText = "PULL!"; btn.classList.add('reeling');
                let baseW = ['legendary','mythic','secret','ancient'].includes(state.pending.r) ? 8 : 15;
                gz.style.width = (baseW + player.upgrades.reelWidth * 2) + '%';
                gz.style.left = Math.random() * (100 - (baseW + player.upgrades.reelWidth * 2)) + '%';
            } else game.fail();
        } else {
            if(hit) game.success(state.pending); else game.fail();
            state.isReeling = false;
            document.getElementById('main-action').innerText = "CAST";
            document.getElementById('main-action').classList.remove('reeling');
        }
    },
    roll: () => {
        let rodLuck = (1 + DB.rods.find(r => r.id === player.rod).b/100);
        let weatherLuck = DB.weather[state.weather].l;
        let levelBonus = 1 + ((player.level - 1) * 0.1);
        let altarMult = (Date.now() < player.boostEnd) ? 1.3 : 1;
        const totalLuck = rodLuck * weatherLuck * levelBonus * altarMult;
        
        const tiers = ['ancient', 'secret', 'mythic', 'legendary', 'epic', 'rare', 'common'];
        for(let t of tiers) { if(Math.random() < (1 / (DB.rarity[t].c / totalLuck))) {
            const pool = DB.fish.filter(f => f.r === t); return pool[Math.floor(Math.random()*pool.length)];
        }}
        return DB.fish[0];
    },
    success: (item) => {
        state.isMoving = false; 
        player.items.push(item);
        if(!player.found.includes(item.n)) player.found.push(item.n);
        
        if(player.level < 100) {
            player.xp += DB.rarity[item.r].xp;
            if(player.xp >= player.maxXp) {
                player.level++; 
                player.xp = 0; 
                player.maxXp = Math.floor(player.maxXp * 1.5);
                ui.toast(`LEVEL UP! Level ${player.level}`);
            }
        }

        if(!player.quest.completed) {
            const q = DB.quests[player.quest.stage];
            if(q.target === 'level') player.quest.progress = player.level;
            else if(q.target === 'any' || item.r === q.target) player.quest.progress++;
            
            if(player.quest.progress >= q.count) {
                player.quest.stage++; player.quest.progress = 0;
                if(player.quest.stage >= DB.quests.length) {
                    player.quest.completed = true; player.ownedRods.push('god_slayer');
                    ui.toast("üó°Ô∏è GOD SLAYER UNLOCKED!");
                } else { ui.toast("Quest Stage Cleared!"); }
            }
        }

        game.save(); ui.showGacha(item); ui.update();
    },
    fail: () => { 
        state.isMoving = false; 
        ui.toast("Missed!"); 
        setTimeout(() => { 
            state.isMoving = true; 
            game.lastTime = performance.now(); // Reset time agar tidak loncat saat resume
            ui.update(); 
        }, 600); 
    },
    sacrificeMoney: () => {
        if(player.money >= 500) {
            player.money -= 500; const item = game.roll();
            player.items.push(item); if(!player.found.includes(item.n)) player.found.push(item.n);
            game.save(); ui.update(); ui.showGacha(item);
        } else ui.toast("Need $500!");
    },
    sacrificeFish: () => {
        const idx = player.items.findIndex(i => ['legendary','mythic','secret','ancient'].includes(i.r));
        if(idx === -1) { ui.toast("Need Legendary+ Fish!"); return; }
        player.items.splice(idx, 1);
        player.boostEnd = Date.now() + (5 * 60 * 1000);
        ui.toast("1.3x Luck Activated!"); game.save(); ui.update();
    },
    buyUpgrade: () => {
        const cost = 5000 * Math.pow(3, player.upgrades.reelWidth);
        if(player.upgrades.reelWidth < 5 && player.money >= cost) {
            player.money -= cost; player.upgrades.reelWidth++;
            game.save(); ui.update(); ui.tab('upgrade', document.querySelector('[onclick*="upgrade"]'));
        } else ui.toast(player.upgrades.reelWidth >= 5 ? "Max Level!" : "Cannot upgrade!");
    },
    sellAll: () => {
        const sellMult = DB.weather[state.weather].s;
        const total = player.items.reduce((a, b) => a + (b.v * sellMult), 0);
        player.money += total; player.items = [];
        game.save(); ui.update(); ui.tab('inv', document.querySelector('[onclick*="inv"]'));
        ui.toast(`Sold all for $${Math.floor(total).toLocaleString()}`);
    },
    save: () => localStorage.setItem('ocean_v45', JSON.stringify(player))
};

const ui = {
    update: () => {
        const moneyTxt = `$${Math.floor(player.money).toLocaleString()}`;
        const lvlTxt = `Lvl ${player.level}${player.level >= 100 ? '(MAX)' : ''}`;
        
        document.getElementById('stat-money').innerText = moneyTxt;
        document.getElementById('lvl-display').innerText = lvlTxt;
        document.getElementById('luck-bonus-display').innerText = `+${Math.floor((player.level-1)*10)}% Luck`;
        document.getElementById('xp-bar').style.width = player.level >= 100 ? '100%' : (player.xp / player.maxXp * 100) + '%';
        document.getElementById('xp-text').innerText = player.level >= 100 ? 'MAX' : `${Math.floor(player.xp)} / ${Math.floor(player.maxXp)} XP`;
        
        document.getElementById('m-money').innerText = moneyTxt;
        document.getElementById('m-lvl').innerText = lvlTxt;

        const curRod = DB.rods.find(r => r.id === player.rod);
        let totalLuck = (1 + curRod.b/100) * DB.weather[state.weather].l * (1 + (player.level-1)*0.1) * (Date.now() < player.boostEnd ? 1.3 : 1);
        document.getElementById('rod-display').innerText = curRod.n;
        document.getElementById('rod-info').innerText = `Total Luck: ${totalLuck.toFixed(1)}x`;
        document.getElementById('weather-display').innerText = `${DB.weather[state.weather].n} (${DB.weather[state.weather].l}x Luck)`;
        document.getElementById('sell-bonus-display').innerText = `Selling: ${DB.weather[state.weather].s}x Value`;
    },
    updateWeatherFX: () => {
        const w = DB.weather[state.weather];
        const fxLayer = document.getElementById('weather-fx');
        fxLayer.innerHTML = '';
        fxLayer.style.background = w.bg;
        
        if(w.fx === 'rain' || w.fx === 'storm') {
            for(let i=0; i<50; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animation = `rain ${0.5 + Math.random()}s linear infinite`;
                p.style.opacity = Math.random();
                fxLayer.appendChild(p);
            }
            if(w.fx === 'storm') {
                const l = document.createElement('div');
                l.className = 'lightning';
                fxLayer.appendChild(l);
            }
        } else if(w.fx === 'snow') {
            for(let i=0; i<50; i++) {
                const p = document.createElement('div');
                p.className = 'particle snow-particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animation = `snow ${2 + Math.random() * 3}s linear infinite`;
                fxLayer.appendChild(p);
            }
        }
    },
    tab: (id, btn) => {
        document.querySelectorAll('.content').forEach(c => c.style.display = 'none');
        document.getElementById('tab-'+id).style.display = 'flex';
        if(id !== 'game') document.getElementById('tab-'+id).style.flexDirection = 'column';
        document.querySelectorAll('.sidebar .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(id === 'quest') ui.renderQuest();
        if(id === 'inv') {
            const sellMult = DB.weather[state.weather].s;
            const totalValue = player.items.reduce((a, b) => a + (b.v * sellMult), 0);
            document.getElementById('bag-total-value').innerText = `Est. Value: $${Math.floor(totalValue).toLocaleString()}`;
            document.getElementById('inv-grid').innerHTML = player.items.map(i => `<div class="card"><b>${i.ico} ${i.n}</b><br><small style="color:${DB.rarity[i.r].col}">${i.r}</small></div>`).join('');
        }
        if(id === 'shop') document.getElementById('shop-grid').innerHTML = DB.rods.map(r => {
            const owned = player.ownedRods.includes(r.id);
            if(r.quest && !owned) return `<div class="card" style="border:1px solid var(--purple);"><b>???</b><br><small>Quest Reward</small></div>`;
            const luckMult = (1 + r.b/100).toFixed(1);
            return `<div class="card">
                <b>${r.n}</b><br>
                <div style="color:var(--green); font-size:10px; margin: 4px 0;">Luck: ${luckMult}x</div>
                <button class="btn" style="width:100%; justify-content:center;" onclick="ui.buyRod('${r.id}')">${owned ? (player.rod===r.id?'ACTIVE':'USE') : '$'+r.cost.toLocaleString()}</button>
            </div>`;
        }).join('');
        if(id === 'upgrade') {
            const cost = 5000 * Math.pow(3, player.upgrades.reelWidth);
            document.getElementById('upgrade-list').innerHTML = `<div class="card"><h3>Reel Level ${player.upgrades.reelWidth}/5</h3><button class="btn" style="justify-content:center;" onclick="game.buyUpgrade()">${player.upgrades.reelWidth >= 5 ? 'MAX' : 'UPGRADE ($'+cost.toLocaleString()+')'}</button></div>`;
        }
        if(id === 'index') document.getElementById('index-grid').innerHTML = DB.fish.map(i => `<div class="card" style="opacity:${player.found.includes(i.n)?1:0.2}"><b>${player.found.includes(i.n)?i.ico+' '+i.n:'???'}</b><br><small style="color:${DB.rarity[i.r].col}">${i.r}</small></div>`).join('');
    },
    renderQuest: () => {
        const qElem = document.getElementById('quest-display');
        if(player.quest.completed) { qElem.innerHTML = `<h2 style="color:var(--gold);">CHAMPION</h2><p>You own the God Slayer.</p>`; return; }
        const q = DB.quests[player.quest.stage];
        if(q.target === 'level') player.quest.progress = player.level;
        const pct = Math.min(100, (player.quest.progress / q.count) * 100);
        qElem.innerHTML = `<h3>Mission ${player.quest.stage + 1}</h3><p>${q.desc}</p><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div><p style="text-align:right;">${Math.min(q.count, player.quest.progress)} / ${q.count}</p>`;
    },
    buyRod: (id) => {
        const r = DB.rods.find(x => x.id === id);
        if(player.ownedRods.includes(id)) player.rod = id;
        else if(player.money >= r.cost) { player.money -= r.cost; player.ownedRods.push(id); player.rod = id; }
        game.save(); ui.update(); ui.tab('shop', document.querySelector('[onclick*="shop"]'));
    },
    showGacha: (item) => {
        document.getElementById('gacha-overlay').style.display = 'flex';
        document.getElementById('g-icon').innerText = item.ico;
        document.getElementById('g-name').innerText = item.n;
        document.getElementById('g-name').className = `gacha-name r-${item.r}`;
        document.getElementById('g-rarity').innerText = item.r.toUpperCase();
        document.getElementById('g-rarity').style.color = DB.rarity[item.r].col;
    },
    closeGacha: () => { 
        document.getElementById('gacha-overlay').style.display = 'none'; 
        state.isMoving = true; 
        game.lastTime = performance.now(); // Reset time to prevent jump
    },
    toast: (m) => { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 1500); }
};

window.onkeydown = (e) => { if(e.code === 'Space') game.handleAction(); };
document.getElementById('main-action').addEventListener('touchstart', (e) => {
    e.preventDefault(); 
    game.handleAction();
});
game.init();
</script>
</body>
</html>